/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import"../../lang.js";import{p as e,g as t,c as r}from"../../../chunks/metadata.js";import{L as n}from"../../../chunks/Logger.js";import{d as o}from"../../../chunks/ensureType.js";import{s as i}from"../../../chunks/object.js";import s,{M as a}from"../../Error.js";import"../../../chunks/handleUtils.js";import"../../../config.js";import"../../../chunks/string.js";let c,u=[];const f=n.getLogger("esri.core.Accessor");function p(e){void 0!==c&&c.onObservableAccessed(e)}let l=!1,y=!1;function d(e,t,r){if(l)return w(e,t,r);j(e);const n=t.call(r);return b(),n}function g(e,t){return d(void 0,e,t)}function w(e,t,r){const n=l;l=!0,j(e);let o=null;try{o=t.call(r)}catch(e){y&&f.error(e)}return b(),l=n,o}function j(e){c=e,u.push(e)}function b(){const e=u.pop();c=u.length>0?u[u.length-1]:void 0,void 0!==e&&e.onTrackingEnd()}function m(e,t){if(32&t.flags)return;const r=y;y=!1,64&t.flags?w(t,t.metadata.get,e):v(e,t),y=r}const h=[];function v(t,r){128&r.flags||(r.flags|=128,w(r,(()=>{const n=r.metadata.dependsOn||h;for(const r of n)if("string"==typeof r&&-1===r.indexOf("."))A(t,r,!1);else{const n=e(r);for(let e=0,r=t;e<n.length&&null!=r&&"object"==typeof r;++e)r=A(r,n[e],e!==n.length-1)}})),r.flags&=-129)}function A(e,r,n){const o="?"===r[r.length-1]?r.slice(0,-1):r;if(null!=e.getItemAt||Array.isArray(e)){const t=parseInt(o,10);if(!isNaN(t))return Array.isArray(e)?e[t]:e.getItemAt(t)}const i=t(e),s=null==i?void 0:i.properties.get(o);return s&&(p(s),m(e,s)),n?e[o]:void 0}class O extends a{constructor(e,t,r){if(super(e,t,r),!(this instanceof O))return new O(e,t,r)}}function _(e){return!!e&&e.prototype&&e.prototype.declaredClass&&0===e.prototype.declaredClass.indexOf("esri.core.Collection")}O.prototype.type="warning";const k=n.getLogger("esri.core.accessorSupport.extensions.serializableProperty.reader");function x(e,t,r){var n,o;e&&(!r&&!t.read||null!=(n=t.read)&&n.reader||!1===(null==(o=t.read)?void 0:o.enabled)||function(e){if("types"in e)return $(e.types);return P(e.type)}(e)&&i("read.reader",N(e),t))}function N(e){var t;const r=null!=(t=e.ndimArray)?t:0;if(r>1)return function(e){var t;const r=C(e),n=T.bind(null,r),o=null!=(t=e.ndimArray)?t:0;return(e,t,r)=>{if(null==e)return e;e=n(e,r,o);let i=o,s=e;for(;i>0&&Array.isArray(s);)i--,s=s[0];if(void 0!==s)for(let t=0;t<i;t++)e=[e];return e}}(e);if(1===r)return z(e);if("type"in e&&M(e.type)){var n,o;const t=null==(n=e.type.prototype)||null==(o=n.itemType)?void 0:o.Type,r=z("function"==typeof t?{type:t}:{types:t});return(t,n,o)=>{const i=r(t,n,o);return i?new e.type(i):i}}return C(e)}function C(e){return"type"in e?function(e){if(e.prototype.read)return(t,r,n)=>{if(null==t)return t;const o=typeof t;if("object"!==o)return void k.error(`Expected JSON value of type 'object' to deserialize type '${e.prototype.declaredClass}', but got '${o}'`);const i=new e;return i.read(t,n),i};return e.fromJSON}(e.type):function(e){var t;let n=null;const o=null!=(t=e.errorContext)?t:"type";return(t,i,s)=>{if(null==t)return t;const a=typeof t;if("object"!==a)return void k.error(`Expected JSON value of type 'object' to deserialize, but got '${a}'`);n||(n=function(e){const t={};for(const i in e.typeMap){var n,o;const s=e.typeMap[i],a=r(s.prototype);if("function"==typeof e.key)continue;const c=a.properties[e.key];if(!c)continue;null!=(n=c.json)&&n.type&&Array.isArray(c.json.type)&&1===c.json.type.length&&"string"==typeof c.json.type[0]&&(t[c.json.type[0]]=s);const u=null==(o=c.json)?void 0:o.write;if(!u||!u.writer){t[i]=s;continue}const f=u.target,p="string"==typeof f?f:e.key,l={};u.writer(i,l,p),l[p]&&(t[l[p]]=s)}return t}(e));const c=e.key;if("string"!=typeof c)return;const u=t[c],f=u?n[u]:e.defaultKeyValue?e.typeMap[e.defaultKeyValue]:void 0;if(!f){const e=`Type '${u||"unknown"}' is not supported`;return s&&s.messages&&t&&s.messages.push(new O(`${o}:unsupported`,e,{definition:t,context:s})),void k.error(e)}const p=new f;return p.read(t,s),p}}(e.types)}function T(e,t,r,n){return 0!==n&&Array.isArray(t)?t.map((t=>T(e,t,r,n-1))):e(t,void 0,r)}function z(e){const t=C(e);return(e,r,n)=>{if(null==e)return e;if(Array.isArray(e)){const r=[];for(const o of e){const e=t(o,void 0,n);void 0!==e&&r.push(e)}return r}const o=t(e,void 0,n);return void 0!==o?[o]:void 0}}function M(e){if(!_(e))return!1;const t=e.prototype.itemType;return!(!t||!t.Type)&&("function"==typeof t.Type?P(t.Type):$(t.Type))}function P(e){return!Array.isArray(e)&&(!!e&&e.prototype&&("read"in e.prototype||"fromJSON"in e||M(e)))}function $(e){for(const t in e.typeMap){if(!P(e.typeMap[t]))return!1}return!0}function S(e){e.name&&(e.read&&"object"==typeof e.read?void 0===e.read.source&&(e.read.source=e.name):e.read={source:e.name},e.write&&"object"==typeof e.write?void 0===e.write.target&&(e.write.target=e.name):e.write={target:e.name})}function E(e){"boolean"==typeof e.read?e.read={enabled:e.read}:"function"==typeof e.read?e.read={enabled:!0,reader:e.read}:e.read&&"object"==typeof e.read&&void 0===e.read.enabled&&(e.read.enabled=!0)}function L(e){"boolean"==typeof e.write?e.write={enabled:e.write}:"function"==typeof e.write?e.write={enabled:!0,writer:e.write}:e.write&&"object"==typeof e.write&&void 0===e.write.enabled&&(e.write.enabled=!0)}const J=n.getLogger("esri.core.accessorSupport.extensions.serializableProperty.writer");function V(e,t){var r;if(!t.write||t.write.writer||!1===t.write.enabled&&!t.write.overridePolicy)return;const n=null!=(r=null==e?void 0:e.ndimArray)?r:0;var o,s;e&&(1===n||"type"in e&&_(e.type))?t.write.writer=F:n>1?t.write.writer=(s=n,function(e,t,r,n){let o;if(null===e)o=null;else{o=W(e,n,s);let t=s,r=o;for(;t>0&&Array.isArray(r);)t--,r=r[0];if(void 0!==r)for(let e=0;e<t;e++)o=[o]}i(r,o,t)}):t.types?Array.isArray(t.types)?t.write.writer=(o=t.types[0],(e,t,r,n)=>e&&Array.isArray(e)?I(e.filter((e=>U(e,o,n))),t,r,n):I(e,t,r,n)):t.write.writer=function(e){return(t,r,n,o)=>t?U(t,e,o)?I(t,r,n,o):void 0:I(t,r,n,o)}(t.types):t.write.writer=I}function U(e,t,r){for(const r in t.typeMap)if(e instanceof t.typeMap[r])return!0;if(null!=r&&r.messages){var n,o;const i=null!=(n=t.errorContext)?n:"type",a=`Values of type '${null!=(o="function"!=typeof t.key?e[t.key]:e.declaredClass)?o:"Unknown"}' cannot be written`;r&&r.messages&&e&&r.messages.push(new s(`${i}:unsupported`,a,{definition:e,context:r})),J.error(a)}return!1}function I(e,t,r,n){i(r,K(e,n),t)}function K(e,t){return e&&"function"==typeof e.write?e.write({},t):e&&"function"==typeof e.toJSON?e.toJSON():"number"==typeof e?X(e):e}function X(e){return e===-1/0?-Number.MAX_VALUE:e===1/0?Number.MAX_VALUE:isNaN(e)?null:e}function F(e,t,r,n){let o;null===e?o=null:e&&"function"==typeof e.map?(o=e.map((e=>K(e,n))),"function"==typeof o.toArray&&(o=o.toArray())):o=[K(e,n)],i(r,o,t)}function W(e,t,r){return 0!==r&&Array.isArray(e)?e.map((e=>W(e,t,r-1))):K(e,t)}function q(e,t){return D(e,"read",t)}function B(e,t){return D(e,"write",t)}function D(e,t,r){let n=e&&e.json;if(e&&e.json&&e.json.origins&&r){const o=e.json.origins[r.origin];o&&("any"===t||t in o)&&(n=o)}return n}function G(e){const t=function(e){if(e.json.types)return R(e.json);if(e.type)return Q(e);return R(e)}(e);if(e.json.origins)for(const r in e.json.origins){const n=e.json.origins[r],o=n.types?H(n):t;x(o,n,!1),n.types&&!n.write&&e.json.write&&e.json.write.enabled&&(n.write={...e.json.write}),V(o,n)}x(t,e.json,!0),V(t,e.json)}function H(e){return e.type?Q(e):R(e)}function Q(e){if(!e.type)return;let t=0,r=e.type;for(;Array.isArray(r)&&!o(r);)r=r[0],t++;return{type:r,ndimArray:t}}function R(e){if(!e.types)return;let t=0,r=e.types;for(;Array.isArray(r);)r=r[0],t++;return{types:r,ndimArray:t}}function Y(e){(function(e){if(e.json||(e.json={}),E(e.json),L(e.json),S(e.json),e.json.origins)for(const t in e.json.origins)E(e.json.origins[t]),L(e.json.origins[t]),S(e.json.origins[t]);return!0})(e)&&(!function(e){if(e.json&&e.json.origins){const t=e.json.origins,r={"web-document":["web-scene","web-map"]};for(const e in r)if(t[e]){const n=t[e];r[e].forEach((e=>{t[e]=n})),delete t[e]}}}(e),G(e))}const Z=new Set,ee=new Set;function te(e){return t=>{t.prototype.declaredClass=e,ne(t);const n=[],o=[];let i=t.prototype;for(;i;)i.hasOwnProperty("initialize")&&!Z.has(i.initialize)&&(Z.add(i.initialize),n.push(i.initialize)),i.hasOwnProperty("destroy")&&!ee.has(i.destroy)&&(ee.add(i.destroy),o.push(i.destroy)),i=Object.getPrototypeOf(i);Z.clear(),ee.clear();class s extends t{constructor(...e){if(super(...e),this.constructor===s&&"function"==typeof this.postscript){if(n.length&&Object.defineProperty(this,"initialize",{enumerable:!1,configurable:!0,value(){for(let e=n.length-1;e>=0;e--)n[e].call(this)}}),o.length){let e=!1;Object.defineProperty(this,"destroy",{enumerable:!1,configurable:!0,value(){if(!e){e=!0;for(let e=0;e<o.length;e++)o[e].call(this)}}})}this.postscript(...e)}}}return s.__accessorMetadata__=r(t.prototype),s.prototype.declaredClass=e,s}}function re(e,t){return null==t.get?function(){const t=this.__accessor__.properties.get(e);if(void 0===t)return;p(t);const r=this.__accessor__.store;return r.has(e)?r.get(e):t.metadata.value}:function(){const t=this.__accessor__.properties.get(e);if(void 0!==t)return t.getComputed()}}function ne(e){const t=e.prototype,n=r(t).properties,o={};for(const e of Object.getOwnPropertyNames(n)){const t=n[e];Y(t),o[e]={enumerable:!0,configurable:!0,get:re(e,t),set(r){const n=this.__accessor__;if(void 0!==n){if(!Object.isFrozen(this)){if(n.initialized&&t.readOnly)throw new TypeError(`[accessor] cannot assign to read-only property '${e}' of ${this.declaredClass}`);if(2===n.lifecycle&&t.constructOnly)throw new TypeError(`[accessor] cannot assign to construct-only property '${e}' of ${this.declaredClass}`);n.set(e,r)}}else Object.defineProperty(this,e,{enumerable:!0,configurable:!0,writable:!0,value:r})}}}Object.defineProperties(e.prototype,o)}export{O as W,D as a,B as b,v as c,g as d,N as e,ne as finalizeClass,m as i,X as n,q as o,d as r,te as subclass,p as t};
